name: branch-deploy-release-lock

on:
  pull_request:
    branches: 
      - main
    types: [ closed ]

# Permissions needed for reacting and adding comments for IssueOps commands
permissions:
  pull-requests: write
  deployments: write
  contents: write
  checks: read

jobs:
  branch-deploy-release-lock:
      runs-on: ubuntu-latest
      steps:
      - name: checkout-main
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: main
          
      - name: Make the script files executable
        run: chmod +x ./scripts/branch-deploy.sh

      - name: search locks
        id: search-locks
        run: ./scripts/branch-deploy.sh "search-locks" ${{ github.head_ref }}

      - name: unlock on PR merge
        if: ${{github.event.pull_request.merged == true && steps.search-locks.outputs.GITHUB_ACTIVE_LOCKS != ''}}
        uses: github/branch-deploy@v8.0.0
        id: unlock-on-merge
        with:
          unlock_on_merge_mode: "true"
          environment_targets: ${{steps.search-locks.outputs.GITHUB_ACTIVE_LOCKS}}

      - name: unlock pr close
        if: ${{github.event.pull_request.merged == false && steps.search-locks.outputs.GITHUB_ACTIVE_LOCKS != ''}}
        run: ./scripts/branch-deploy.sh "unlock-pr-close" ${{steps.search-locks.outputs.GITHUB_ACTIVE_LOCKS}}

      - name: commit unlock main
        if: steps.search-active-locks.outputs.GITHUB_ACTIVE_LOCKS != ''
        run: ./scripts/branch-deploy.sh "commit-unlock-main" ${{steps.search-locks.outputs.GITHUB_ACTIVE_LOCKS}}
